{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}



{% block content %}
     <link rel="stylesheet" href="https://cdn.datatables.net/1.10.23/css/dataTables.bootstrap4.min.css">

    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.23/js/dataTables.bootstrap4.min.js"></script>
    <main class="content">

        {% include 'includes/navigation.html' %}
            <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>


        {% if d.sf %}
            {% set last = d.sf|last %}
        {% endif %}
        <br>

        <!-- live data -->
        <div class="row justify-content-md-center">
            <!-- live situation -->
            <div class="card border-light shadow-sm">
                <!-- TITLE: live situation -->
                <div class="card-header border-bottom border-light">
                    <h2 class="h5 mb-0">Live situation </h2>
                </div>
                <br>
                <div class="row justify-content-md-center">
                    <div class="col-12 col-sm-6 col-xl-4 mb-4">
                        <div class="card border-light shadow-sm">
                            <div class="card-body">
                                <div class="row d-block d-xl-flex align-items-center">
                                    <div class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
                                        <div class="icon icon-shape icon-md icon-shape-blue rounded mr-4 mr-sm-0"><span
                                                class="fas fa-temperature-high"></span></div>
                                        <div class="d-sm-none">
                                            <h2 class="h5">Temperature</h2>
                                            <h3 class="mb-1">Error</h3>
                                        </div>
                                    </div>
                                    <div class="col-12 col-xl-7 px-xl-0">
                                        <div class="d-none d-sm-block">
                                            <h2 class="h5">Temperature</h2>
                                            <h3 class="mb-1">{{ last.temperature }} °C</h3>
                                        </div>
                                        <span class="icon icon-small"><span
                                                class="fas fa-clock"></span></span> {{ last.timestamp.strftime("%b %d %Y %H:%M:%S") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-xl-4 mb-4">
                        <div class="card border-light shadow-sm">
                            <div class="card-body">
                                <div class="row d-block d-xl-flex align-items-center">
                                    <div class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
                                        <div class="icon icon-shape icon-md icon-shape-blue rounded mr-4 mr-sm-0"><span
                                                class="fas fa-tint"></span></div>
                                        <div class="d-sm-none">
                                            <h2 class="h5">Humidity</h2>
                                            <h3 class="mb-1">Error</h3>
                                        </div>
                                    </div>
                                    <div class="col-12 col-xl-7 px-xl-0">
                                        <div class="d-none d-sm-block">
                                            <h2 class="h5">Humidity</h2>
                                            <h3 class="mb-1"> {{ last.humidity }} % </h3>
                                        </div>
                                        <span class="icon icon-small"><span
                                                class="fas fa-clock"></span></span> {{ last.timestamp.strftime("%b %d %Y %H:%M:%S") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-xl-4 mb-4">
                        <div class="card border-light shadow-sm">
                            <div class="card-body">
                                <div class="row d-block d-xl-flex align-items-center">
                                    <div class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
                                        <div class="icon icon-shape icon-md icon-shape-blue rounded mr-4 mr-sm-0"><span
                                                class="fas fa-balance-scale"></span></div>
                                        <div class="d-sm-none">
                                            <h2 class="h5">Weight</h2>
                                            <h3 class="mb-1">Error</h3>
                                        </div>
                                    </div>
                                    <div class="col-12 col-xl-7 px-xl-0">
                                        <div class="d-none d-sm-block">
                                            <h2 class="h5">Weight</h2>
                                            <h3 class="mb-1">{{ last.weight }} g</h3>
                                        </div>
                                        <span class="icon icon-small"><span
                                                class="fas fa-clock"></span></span> {{ last.timestamp.strftime("%b %d %Y %H:%M:%S") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <br>
        <div class="row">
            <div class="col-12 col-xl-8 mb-4">
                <div class="row">
                    <!-- HiveStatus -->
                    <div class="col-12 mb-4">
                        <div class="card border-light shadow-sm">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h2 class="h5">Hive status</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="card border-light shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between border-bottom border-light pb-3">
                                        <div>
                                            <h6 class="mb-0"><span class="icon icon-xs mr-3"><span
                                                    class="fas fa-passport"></span></span>Hive id</h6>
                                        </div>
                                        <div>
                                            <h6 class="mb-0"><span class="icon icon-xs mr-3"></span>{{ d.hive.hive_id }}</h6>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between border-bottom border-light py-3">
                                        <div>
                                            <h6 class="mb-0"><span class="icon icon-xs mr-3"><span
                                                    class="fas fa-wifi"></span></span>Status</h6>
                                        </div>
                                        <div>
                                            <h6 class="mb-0"><span class="icon icon-xs mr-3"></span>
                                                {% if d.time %}
                                                    Online
                                                {% endif %}
                                                {% if not d.time %}
                                                    Offline
                                                {% endif %}
                                            </h6>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between border-bottom border-light py-3">
                                        <div>
                                            <h6 class="mb-0"><span class="icon icon-xs mr-3"><span
                                                    class="fas fa-layer-group"></span></span>Number of supers</h6>
                                        </div>
                                        <div>
                                            <a href="#" class="text-primary font-weight-bold"><a style="width:25px" class="btn btn-outline-primary btn-sm " href="{{ url_for('home_blueprint.removeSupers',  hive_id = d.hive.hive_id, apiary = d.hive.apiary_id) }}" role="button"> - </a>
                                                  {{ d.hive.n_supers }}   <a style="width:25px" class="btn btn-outline-primary btn-sm " href="{{ url_for('home_blueprint.addSupers',  hive_id = d.hive.hive_id, apiary = d.hive.apiary_id) }}" role="button">+</a> </a>

                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between border-bottom border-light py-3">
                                        <div>
                                            <h6 class="mb-0"><span class="icon icon-xs mr-3"><span
                                                    class="fas fa-map-marker-alt"></span></span>Location</h6>
                                        </div>
                                        <div>
                                            <h6 class="mb-0"><span class="icon icon-xs mr-3"></span>{{ d.loc }}</h6>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between border-bottom border-light py-3">
                                        <div>
                                            <h6 class="mb-0"><span class="icon icon-xs mr-3"><span
                                                    class="fas fa-temperature-low"></span></span>External temperature
                                            </h6>
                                        </div>
                                        <div>
                                            <a href="#" class="text-primary font-weight-bold">{{ d.w.temp }} °C</a>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between border-bottom border-light py-3">
                                        <div>
                                            <h6 class="mb-0"><span class="icon icon-xs mr-3"><span
                                                    class="fas fa-cloud-sun"></span></span>Weather conditions</h6>
                                        </div>
                                        <div>
                                            <a href="#" class="text-primary font-weight-bold">{{ d.w.status }}</a>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between border-bottom border-light py-3">
                                        <div>
                                            <h6 class="mb-0"><span class="icon icon-xs mr-3"><span
                                                    class="fas fa-volume-up"></span></span>Alarm</h6>
                                        </div>
                                        <div>
                                            <a href="#" class="text-primary font-weight-bold">
                                                {% if d.hive.alarm %}
                                                    Active
                                                {% endif %}
                                                {% if not d.hive.alarm %}
                                                    Inactive
                                                {% endif %}
                                            </a>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between pt-3">
                                        <div>
                                            <h6 class="mb-0"><span class="icon icon-xs mr-3"><span
                                                    class="fas fa-door-open"></span></span>Entrance</h6>
                                        </div>
                                        <div>
                                            <div class="form-check form-switch">
                                                <label class="form-check-label" for="flexSwitchCheckDefault">
                                                    <a class="text-primary font-weight-bold">
                                                        {% if d.hive.entrance %}
                                                            Open
                                                        {% endif %}
                                                        {% if not d.hive.entrance %}
                                                            Closed
                                                        {% endif %}
                                                    </a>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-xl-4 mb-4">

                <!-- Control hive -->
                <div class="col-12 px-0 mb-4">
                    <div class="card border-light shadow-sm">
                        <div class="card-header border-bottom border-light d-flex justify-content-between">
                            <h2 class="h5 mb-0">Control hive</h2>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between border-bottom border-light pb-3">
                                <a class="nav-link"
                                   href="{{ url_for('home_blueprint.dashboard', apiary=d.apiary, hive_id=d.hive.hive_id, type="none") }}">
                                    <button class="btn btn-primary" type="button" aria-haspopup="true"
                                            aria-expanded="false">
                                        <span class="fas fa-sync-alt"></span> Refresh data
                                    </button>
                                </a>
                            </div>
                            <div class="d-flex align-items-center justify-content-between border-bottom border-light py-3">
                                <a class="nav-link"
                                   href="{{ url_for('home_blueprint.dashboard', apiary=d.apiary, hive_id=d.hive.hive_id, type="alarm") }}">
                                    <button class="btn btn-primary" type="button" aria-haspopup="true"
                                            aria-expanded="false">
                                        <span class="fas fa-volume-up"></span>
                                        {% if d.hive.alarm %}
                                            Turn alarm off
                                        {% endif %}
                                        {% if not d.hive.alarm %}
                                            Turn alarm on
                                        {% endif %}
                                    </button>
                                </a>
                            </div>
                            <div class="d-flex align-items-center justify-content-between pt-3">
                                <a class="nav-link"
                                   href="{{ url_for('home_blueprint.dashboard', apiary=d.apiary, hive_id=d.hive.hive_id, type="entrance") }}">
                                    <button class="btn btn-primary" type="button" aria-haspopup="true"
                                            aria-expanded="false">
                                        <span class="fas fa-door-open"></span>
                                        {% if d.hive.entrance %}
                                            Close hive entrance
                                        {% endif %}
                                        {% if not d.hive.entrance %}
                                            Open hive entrance
                                        {% endif %}
                                    </button>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- progress -->
                <div class="col-12 px-0 mb-4">
                    <div class="card border-light shadow-sm">
                        <div class="card-header border-bottom border-light">
                            <h2 class="h5 mb-0">Honey production</h2>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center mb-4">
                                <div class="col-auto">
                                    <span class="sidebar-icon">
                                        <img src="/static/assets/img/honey.svg" height="40" width="40" alt="Bee Logo">&nbsp;
                                    </span>
                                </div>
                                <div class="col">
                                    <div class="progress-wrapper">
                                        <div class="progress-info">
                                            <div class="h6 mb-0">Honey quantity</div>

                                            <div class="small font-weight-bold text-dark"><span>{{ d.hp }} %</span></div>
                                        </div>
                                        <div class="progress mb-0">
                                            <div class="progress-bar bg-warning" role="progressbar"

                                                 aria-valuenow="{{ last.weight }}" aria-valuemin="0" aria-valuemax="{{ (d.hive.n_supers*30) + 50  }}"
                                                 style="width: {{ (last.weight * 100)/((d.hive.n_supers*30) + 50) }}%;"></div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <br>
        <!-- grafico -->
        <div class="col-12 mb-4">
            <div class="card bg-yellow-alt shadow-sm">
                <div class="card-header d-flex flex-row align-items-center flex-0">
                    <div class="d-block">
                        <div class="h5 font-weight-normal mb-2">Trend</div>

                    </div>

                </div>
                <div>
                    <div id="chartContainer" style="height: 300px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- tabella dati -->
            <div class="col-12 mb-4">
                        <div class="card border-light shadow-sm">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h2 class="h5">History data</h2>
                                    </div>
                                    <div class="col text-right">
                                        <a href="{{ url_for('home_blueprint.sensorFeed', hive_id = d.hive_id)}}" class="btn btn-sm btn-secondary">See all</a>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                  <table id="mydatatable" class="table align-items-center table-flush">
                                    <thead class="thead-light">
                                    <tr>
                                        <th class="border-0">Id Hive</th>
                                        <th class="border-0">Temperature</th>
                                        <th class="border-0">Humidity</th>
                                        <th class="border-0">Weight</th>
                                        <th class="border-0">Time</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for el in d.sf %}
                                        <tr>
                                            <td class="border-0">
                                                {{ el.hive_id }}
                                            </td>
                                            <td class="border-0">
                                                {{ el.temperature }}
                                            </td>
                                            <td class="border-0">
                                                {{ el.humidity }}
                                            </td>
                                            <td class="border-0">
                                                {{ el.weight }}
                                            </td>
                                            <td class="border-0">
                                                {{ el.timestamp }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
        </div>

        {% include 'includes/footer.html' %}

    </main>
    <script>
$(document).ready(function() {
    $('#mydatatable').DataTable();
} );
</script>
        {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <script>
                    swal('Warning', '{{ message }}', "warning")
                </script>
            {% endfor %}
        {% endif %}
    {% endwith %}
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script>
        window.onload = function () {

            var chart = new CanvasJS.Chart("chartContainer", {
                animationEnabled: true,
                backgroundColor: "#FCE1C3",
                zoomEnabled: true,
                animationEnabled: true,
                axisX: {
                    valueFormatString: "DD MMM,YY"
                },
                axisY: {
                    title: "Graph"
                },
                legend: {
                    cursor: "pointer",
                    fontSize: 16,
                    itemclick: toggleDataSeries
                },
                toolTip: {
                    shared: true
                },
                data: [{
                    name: "Temperature",
                    type: "spline",
                    yValueFormatString: "#0.## °C",
                    showInLegend: true,
                    dataPoints: [
                        {% for p in d.sf %}
                            {label: "{{ p.timestamp.strftime("%b %d %Y %H:%M:%S") }}", y: {{p.temperature}}},
                        {% endfor %}
                    ]
                },
                    {
                        name: "Humidity",
                        type: "spline",
                        yValueFormatString: "##,##%",
                        showInLegend: true,
                        dataPoints: [
                            {% for p in d.sf %}
                                {label: "{{ p.timestamp.strftime("%b %d %Y %H:%M:%S") }}", y: {{p.humidity}}},
                            {% endfor %}
                        ]
                    },
                    {
                        name: "Weight",
                        type: "spline",
                        yValueFormatString: "#0.## g",
                        showInLegend: true,
                        dataPoints: [
                            {% for p in d.sf %}
                                {label: "{{ p.timestamp.strftime("%b %d %Y %H:%M:%S") }}", y: {{p.weight}}},
                            {% endfor %}
                        ]
                    }]
            });

            chart.render();

            function toggleDataSeries(e) {
                if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                    e.dataSeries.visible = false;
                } else {
                    e.dataSeries.visible = true;
                }
                chart.render();
            }


        }
    </script>
{% endblock javascripts %}

